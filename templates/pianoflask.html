<!doctype html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <title>PianoFlask</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&family=Roboto:wght@900&display=swap" rel="stylesheet">    
        
    <!--- link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" --->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    

    <!--- 
    https://www.billboard.com/wp-content/uploads/2022/03/50.-Taylor-Swift-%E2%80%981989-2014-album-art-billboard-1240.jpg?w=768
-
http://mediaserver-cont-dc6-2-v4v6.pandora.com/images/93/29/d6/aa/19c24bc49cbb1249e846ad6a/1080W_1080H.jpg
--->
    
<style>

*, *:before, *:after {
  box-sizing: border-box;
}

* {
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  transform-style: preserve-3d;
}

*:focus {
  outline: none !important;
}

::-moz-selection {
  background: none;
}

::selection {
  background: none;
}

a {
  cursor: pointer;
}

body, html {
    height: 100%;
    margin:0;
    padding:0;
}

hr {
  border: 0;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 1px;
  background: rgba(11, 11, 11, 0.5);
}

body {
  color: #0B0B0B;
  font-family: 'Roboto Condensed', sans-serif;    
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
}

main {
  perspective: 1000px;
  transform-style: preserve-3d;
  display: flex;
  justify-content: center;
  align-items: center;
  align-content: center;
  position: relative;
  width: 100%;
  height: 100%;
  padding: 12px;
}

.background {
  background: white;
}
#backgroundcoverart {
    background: url("{{trackinfo.coverArt}}") center center/cover;
}
.background, .background:before, .background:after, .background div {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  
}
.background:before {
  content: "";
  
  filter: blur(2px);
}
.background div {
  background: #483D8B;
  miSx-blend-mode:darken;
  miSx-blend-mode:screen;
  mix-blend-mode:multiply;
}
.background:after {
  content: "";
  background: rgba(0, 0, 0, 0.15);
}
.player-container {
    position:absolute;
    top:20px;
    top:20px;
}
    
.player {
  position: relative;
  z-index: 3;
  width: 100%;
  max-width: 320px;
}
.player.playlist .front {
  z-index: -1;
  opacity: 0;
}
.player, .front {
  will-change: transform;
  transform-origin: center center;
  transform-style: preserve-3d;
  -webkit-backface-visibility: hidden;
          backface-visibility: hidden;
}

.front {
  transition: all 500ms cubic-bezier(0.175, 0.885, 0.32, 1.275);
  background: white;
  border-radius: 2px;
  box-shadow: 0 0 15px rgba(123, 22, 40, 0.2);
}


.art {
  border-radius: 2px 2px 0 0;
  display: block;
  width: 100%;
}

.controls {
  display: flex;
  align-items: center;
  align-content: center;
  width: 100%;
}



.controls.top .material-symbols-outlined{
    background-color:#f4f731;
    border-radius: 50%;
    boSx-shadow: 8px 8px 2px 1px rgba(255, 255, 255, .8); // rgba(244, 247, 49, .8);
    box-shadow: 4px 4px 2px 1px rgba(0, 0, 0, .8); // rgba(244, 247, 49, .8);
    color:black;
    fWilter: invert(1);
    mix-blend-mode: difference;
    opacity:85%;
}
.controls a {
  display: block;
  height:fit-content;
}
.controls a.skip {
  height: 25px;
  maSrgin-left:45px;
  wiSdth: 90px;
}
.controls a.skip, .controls a.forward  {
  height: 40px;
  maSrgin-left:45px;
  width: 40px;
}



.controls a.play {
  heiSght: 90px;
  overSflow: hidden;
  wiSdth: 90px;
}
.controls a.play .material-symbols-outlined {
  font-size: 90px;
}
.controls a.skip .material-symbols-outlined {
  font-size: 50px;
}
.controls.top {
  align-items: baseline;
  justify-content: space-around;
  position:absolute;
  top:207px;
  padding: 12px;
}
.controls.top a {
  transition: all 250ms ease-out;
  will-change: transform;
}
.controls.top a:hover, .controls.top a:focus {
  transition: all 500ms cubic-bezier(0.175, 0.885, 0.32, 1.275);
  transform: scale(1.1);
}

.controls.top a:active {
  transform: scale(1);
}
.controls.bottom {
  justify-content: space-between;
  padding: 5px 12px 12px;
}
.controls.bottom a {
  width: 40px;
  height: 40px;
}

.controls.loading {
  position:absolute;
  top:-500px;
}


.meta {
  text-align: center;
}
.meta .info {
  padding: 12px;
}
h1 {
  font-size: 20px;
  font-weight: 300;
  height:30px;
  margin-bottom: 6px;
}
h2 {
  font-size: 14px;
  font-weight: 500;
  height:20px;
}
h4 {
  font-size: 12px;
  font-weight: 500;
  height:16px;
  margin-bottom: 0;
}

.material-symbols-outlined {
  font-size:40px;
  font-variation-settings:
  'FILL' 1,
  'wght' 200,
  'GRAD' 0,
  'opsz' 24
}
.station {
    display: block;
    align-items: center;
    width: 100%;
    padding: 0px;
}

.station label {
    color:black;
    font-size:0.7em;
    padding:0;
    width:100%;
    filter: invert(1);
    mix-blend-mode: difference;
}   
.station select {
  background-color:white;
  color:black;
    font-family: 'Roboto Condensed', sans-serif; 
    font-size: 1.2em;
    width:100%;
}    
    
.station select option {
    font-family: 'Roboto Condensed', sans-serif; 
    width:100%;
}  
.controls.bottom .material-symbols-outlined.heart-0 {
  color:#000;
}

.controls.bottom .material-symbols-outlined.heart-1,
.controls.bottom .material-symbols-outlined.heart-2, 
.controls.bottom .material-symbols-outlined.heart-3, 
.controls.bottom .material-symbols-outlined.heart-4, 
.controls.bottom .material-symbols-outlined.heart-5 {
  color: red;
}

#progressbar {
    background-color:white;
    backgroSund-color: black;
    border: 1px solid black;
    display:block;
    height:22px;
    maSrgin:0px 9px 0px 2px;
    padding:0;
    position:relative;
    width:100%;
}

#progSSressbar .background {
  background-color: white;
  filter: invert(1);
    mix-blend-mode: difference;
  
  position:absolute;
  top:0;
  left:0;
          
}

#progressbar #bar {
    background-color:  /* the progress color */
    linear-gradient(#fff8,#fff0),
    repeating-linear-gradient(135deg,#0003 0 10px,#0000 0 20px),
    #f4f731; 
  --backgroSund: lightgrey; /* the background color */

    display:block;
  colSor: black;
  height: 23px;
  width: 100%;
  bacSground-color: black;
  position:absolute;
  left:0px;
  top:0px;
  filter: invert(1);
    mix-blend-mode: difference;
 
}
#progressbar .pbtext {
    color: black;
    display:inline-block;
    font-size: 12px;
    position: absolute;
    top:4px;
}

#progressbar #elapsed {
    left:10px;
    text-align: left;
}
#progressbar #duration {
    left:auto;
    right:10px;
    text-align: right;
}

.offscreen {
    background-color:white;
    color: white;
    display:inline-block;
    position:absolute;
    top:-500px;
    white-space: nowrap;
}

.songinfo {
    height: 1.3em;
    left:0;
    margin:0;
    overflow:hidden;
    position:relative;
    width:100%;
}
.songinfo div {
    display:inline-block;
    left:0;
    overflow:hidden;
    text-align: center;
    text-decoration: none;
    width:100%;
    white-space:nowrap;
}
.songinfo div.scrollable {
    text-align:left;
    text-overflow: ellipsis;
}
.songinfo div.scrolling {
    overflow:visible;
    position:relative;
    text-align:left;
}
 
progress[value] {
    --origcolor:  /* the progress color */
    linear-gradient(rgba(255, 255, 255, 0.533),#fff0),
    repeating-linear-gradient(135deg,#0003 0 10px,#0000 0 20px),
    rgb(244, 247, 49); 
    --color:  /* the progress color */
    
    repeating-linear-gradient(135deg,#0003 0 10px,#0000 0 20px),
    #f4f731; 
  --background: black; /* the background color */
  -webkit-appearance: none;
  -moz-appearance: none;

  appearance: none;
  background: var(--background);
  border: none;
  border-radius: 0;
  height:20px;
  margin: 0;
  padding:0;
  width: 100%;

  filter: invert(1);
    mix-blend-mode: difference;

}
progress[value]::-webkit-progress-bar {
  border-radius: 0em;
  background: var(--background);
}
progress[value]::-webkit-progress-value {
  border-radius: 0em;
  background: var(--color);
}
progress[value]::-moz-progress-bar {
  border-radius: 0em;
  background: var(--color);
}




@media only screen and (max-height: 510px) {
  .container {
    transform-origin: center center;
    transform: scale(0.75);
  }
}
@media only screen and (min-width: 640px) {
  .with-hover .player {
    transition: all 500ms ease-out;
  }
  .with-hover .player:hover {
    transition: all 1000ms cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .player {
    will-change: transform;
  }
  .player:hover {
    transform: translateZ(60px);
  }
  .player.playlist .front {
    transform: rotateY(180deg);
  }
  .player.playlist .front * {
    opacity: 0;
  }
}


      </style>
</head>

<body>
    <h1 id="trackContent" class="offscreen">{{trackinfo.title}}</h1>
    <h2 id="artistContent" class="offscreen">{{trackinfo.artist}}</h2>
    <h4 id="albumContent" class="offscreen">{{trackinfo.album}}</h4>

    <main class="with-hover">
        <div id="backgroundcoverart" class='background'>
            <div></div>
        </div>
        <div class='container player-container'>
            <div class='player'>
                <div class="station">
                    <label>Station:</label>
                    <select id="selectStation" data-station="{{trackinfo.stationName}}">   
                    {% for station in stationlist %}
                    {% if station.name|length >0 %}
                        {% if station.name == trackinfo.stationName %}
                            <option value="{{station.id}}" selected>{{station.name}}</option>
                        {% else %}
                            <option value="{{station.id}}">{{station.name}}</option>
                        {% endif %}
                    {% endif %}
                    {% endfor %}
                    </select>
                </div><!-- #station -->   
                <div class='front'>
                    <img id="coverart" class='art' src='{{trackinfo.coverArt}}' />
                    <div class='controls top loading'>
                        <a class='rewind skip'></a>
                        
                        {% if pianobarpaused == true %}
                        <a id="buttonPlayPause" class='play' data-mode="play">
                            <span class="material-symbols-outlined">play_arrow</span>
                        </a>
                        {% else %}
                        <a id="buttonPlayPause" class='play' data-mode="pause">
                            <span class="material-symbols-outlined">pause</span>
                        </a>
                        {% endif %}
                        
                        <a id="buttonSongnext" class='forward'>
                        <span class="material-symbols-outlined">fast_forward</span>
                        </a>
                    </div><!-- .controls .top -->

                    <div class='meta'>
                        <div id="progressbar" data-started="{{trackinfo.started}}" data-duration={{progress.durationSec}} data-elapsed={{progress.elapsedSec}} data-paused={{pianobarpaused}} data-pausedduration={{progress.pausedDuration}}>
                            <span id="elapsed" class="pbtext">{{progress.elapsed}}</span>
                            <span id="duration" class="pbtext">{{progress.duration}}</span>
                            <!---div id="bar">&nbsp;</div ---><!-- #bar -->
                            <progress id="trackelapsed" max="{{progress.durationSec}}" value="{{progress.elapsedSec}}">{{progress.percent}}</progress>
                        </div><!-- progressbar -->
                        
                        <div class='info'>
                            <h1 id="track" class="songinfo"><div class="static">{{trackinfo.title}}</div></h1>
                            <h2 id="artist" class="songinfo"><div class="static">{{trackinfo.artist}}</div></h2>
                            <h4 id="album" class="songinfo"><div class="static">{{trackinfo.album}}</div></h4>
                        </div><!-- #info -->
                        <div class='controls bottom loading'>
                            <a id="butttonSongban">
                                <span class="material-symbols-outlined">thumb_down</span>
                            </a>
                            <a id="buttonSongtired">
                                <span class="material-symbols-outlined">calendar_clock</span>
                            </a>
                            <a id="buttonSonglove">
                                <span class="material-symbols-outlined heart-{{trackinfo.rating}}">thumb_up</span>
                            </a>
                        </div><!-- .controls .bottom -->
                    </div><!-- #meta -->
                </div><!-- #front -->
            </div><!-- #player -->
        </div><!-- .player-container -->
    </main>

<!--- /div --->


</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
   integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
   crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js" integrity="sha512-zoJXRvW2gC8Z0Xo3lBbao5+AS3g6YWr5ztKqaicua11xHo+AvE1b0lT9ODgrHTmNUxeCw0Ry4BGRYZfXu70weg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>

const SCROLLABLE = 'scrollable';
const SCROLLING = 'scrolling';
const STATIC = 'static';

/*
    HELPER FUNCTIONS 
*/
function padZero(v) {
  return (v < 10) ? "0" + v : v;
}

function sToTime(t) {
  return padZero(parseInt((t / (60 * 60)) % 24)) + ":" +
         padZero(parseInt((t / (60)) % 60)) + ":" + 
         padZero(parseInt((t) % 60));
}

function setScrollable( segment, scrollstatus ){
  console.log("setting "+segment+" set to "+scrollstatus)
  $("#" + segment + " div").removeClass(STATIC).removeClass(SCROLLABLE).removeClass(SCROLLING).addClass(scrollstatus);
}

function scrollTitle( segment ){
  var titleContent = $('#' + segment + 'Content');
  var titleDisplay = $('#' + segment);
  var titleContainer = $('#' + segment + ' div');

  if( titleContainer.hasClass(SCROLLABLE) ){
    console.log("start animation");
    setScrollable(segment, SCROLLING);
    maxScroll = parseInt(titleDisplay.width() - titleContent.width());
    titleContainer.animate({ "left": (""+maxScroll+"px") }, 5000, function() {
      setTimeout(function() {
          // get the fonts a second to load, then check the initial widths of text fields
          if( titleContainer.hasClass(SCROLLING) ){
            setScrollable(segment, SCROLLABLE);
            titleContainer.css('left', 0);
          }
      }, 1000);
      console.log("animation complete");
    });
  }
}

/*
  check if any of the text field - artist, title or album - exceed the width of
  the interface, and if so set up scrolling animation
*/
function checkTextWidth( segment ){
    if( $('#' + segment + 'Content').width() > $('#' + segment).width() ){
        console.log('the '+segment+' needs scrolling - adding the scrolling class');
        setScrollable(segment, SCROLLABLE);
    } else {
        console.log('the '+segment+' does not need scrolling - removing the scrolling class');
        setScrollable(segment, STATIC);
    }
}

// pianobar has changed tracks, update the interface with new song info
function setSongInfo(songinfo){
  artistDisplay = $("#artist div");
  trackDisplay = $("#track div");
  albumDisplay = $("#album div");

  artistDisplay.stop();
  trackDisplay.stop();
  albumDisplay.stop();
  artistDisplay.html(songinfo.artist);
  trackDisplay.html(songinfo.title);
  albumDisplay.html(songinfo.album);

  
  $("#artistContent").html(songinfo.artist);
  $("#trackContent").html(songinfo.title);
  $("#albumContent").html(songinfo.album);

  var progressElem = $("#progressbar");
  progressElem.data("started",songinfo.started);
  progressElem.data("duration",songinfo.songDuration);
  progressElem.data("pausedduration",0);
  progressElem.data('elapsed',0);

  setScrollable('artist', STATIC);
  setScrollable('track', STATIC);
  setScrollable('album', STATIC);

  // setElapsed();
  checkTextWidth('artist');
  checkTextWidth('track');
  checkTextWidth('album');

  $('#coverart').attr("src",songinfo.coverArt);
  $('#backgroundcoverart').css('background-image', "url('" + songinfo.coverArt + "')");
  $("#selectStation option").filter(function() {
      //may want to use $.trim in here
      return $(this).text() == songinfo.stationName;
  }).prop('selected', true);
  $("#selectStation").data("station",songinfo.stationName);
  if(songinfo.rating > 0){
    $("#buttonSonglove .material-symbols-outlined").removeClass("heart-0").removeClass("heart-1").addClass("heart-1");
  } else {
    $("#buttonSonglove .material-symbols-outlined").removeClass("heart-0").removeClass("heart-1").addClass("heart-0");
  }

}


console.log("SOCKET CREATE:");
connection_path = location.protocol + '//' + document.domain + ':' + location.port
console.log(connection_path);
var socket = io.connect(connection_path);
console.log(socket);

/* INTERFACE ELEMENT EVENTS */
$("#buttonPlayPause").on("click", function(event){
    var currentMode = $(this).data("mode");
    if( currentMode=="pause" ){
      // $("#progressbar").data("paused",true);
      socket.emit('pause', {command:"S"});
    } else {
      // $("#progressbar").data("paused",false);
      socket.emit('resume', {command:"P"});
    }
});

$("#buttonSonglove").on("click", function(event){
    socket.emit('songlove', {command:"+"});
});

$("#buttonSongtired").on("click", function(event){
    socket.emit('songtired', {command:"t"});
});

$("#buttonSongban").on("click", function(event){
    socket.emit('songban', {command:"-"});
});

$("#buttonSongnext").on("click", function(event){
    console.log("next song");
    socket.emit('songnext', {command:"n"});
});

$("#selectStation").on("change",function(event){
  chosenStation = $(this).val();
  previousStation = $(this).data("stationName");
  console.log(chosenStation);
  if(chosenStation != previousStation) {
    socket.emit('stationchange', {command:"s", id:chosenStation});
  }
});


socket.on('updateprogress', function(progress) {
    $("#trackelapsed").attr("max", progress["durationSec"]);
    $("#trackelapsed").attr("value", progress["elapsedSec"]);
    $("#trackelapsed").html( progress["percent"] );

    $("#elapsed").html( progress["elapsed"] );
    $("#duration").html( progress["duration"] );
});

socket.on('updatetrack', function(songinfo) {
    console.log("updatetrack")
    console.log(songinfo);
    setSongInfo(songinfo["trackinfo"])
});

socket.on('done_loading', function(msg) {
  // setSongInfo(msg);
  // setElapsed();
  console.log("done_loading");
  console.log(msg);
});


socket.on('commandsuccessfull', function(msg) {
    console.log("commandsuccessfull");
    console.log(msg);
    var commandChar = "";
    var commandId = 0;
    if(msg && msg.command && msg.command.length > 0){
      commandChar = msg.command.charAt(0);
      if(msg.id && msg.id.length > 0){
        commandId = msg.id;
      }
    }
    console.log(commandChar);
    switch( commandChar ){
      case "S":
        console.log("pause");
        $("#buttonPlayPause").data("mode","play");
        $("#buttonPlayPause .material-symbols-outlined").html("play_arrow");
        break;
      case "P":
        console.log("resume");
        $("#buttonPlayPause").data("mode","pause");
        $("#buttonPlayPause .material-symbols-outlined").html("pause");
        break;
      case "s":
        console.log("change station");
      case "+":
        console.log("love track");
        $("#favoriteButton .material-symbols-outlined").removeClass("heart-0").removeClass("heart-1").addClass("heart-1");
        break;
      default:
        console.log("default");
        break;


    }
});


$(document).ready(function() {
  // set up timer to update progressbar
  setInterval(function() {
    socket.emit('getprogress', {data:"getprogress"});
  }, 1000 );

  // set up timer to operate text scrolling, if necessary
  setInterval(function() {
    scrollTitle('artist');
    scrollTitle('track');
    scrollTitle('album');  
  }, 5000 );

  /* 
    give the fonts a second to load when page is initially created
    so that the calculated widths of text fields are accurate
    SHOULD ONLY RUN ONCE!
  */
  setTimeout(function() {
    console.log("one ping only, vasili");
    checkTextWidth('artist');
    checkTextWidth('track');
    checkTextWidth('album');
    $('.controls.loading').removeClass('loading');
  }, 500);

});
</script>
</html>